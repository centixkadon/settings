#!/bin/bash

DIR=$(cd $(dirname $0); pwd)
. ${DIR}/initial


# install v2ray

# gitClone https://github.com/v2ray/v2ray-core.git ${GITHUB_PATH}/v2ray/v2ray-core
# sudo bash ${GITHUB_PATH}/v2ray/v2ray-core/release/install-release.sh


# config v2ray

readVariable "v2ray server domain" V2RAY_SERVER_ADDR
readVariable "v2ray vmess port" V2RAY_VMESS_PORT $(($RANDOM + 10000))
readVariable "v2ray v2ctl port" V2RAY_V2CTL_PORT $(($RANDOM + 10000))
readVariable "v2ray path" V2RAY_WEBSOCKET_PATH /$(uuidgen)

mkdir -p ${SETTINGS_PATH}/v2ray/test/server
${DIR}/config ${SETTINGS_PATH}/v2ray/server/config.json ${SETTINGS_PATH}/v2ray/test/server/config.json -k inbounds.0.port -i ${V2RAY_VMESS_PORT} -k inbounds.1.port -i ${V2RAY_V2CTL_PORT} -k inbounds.0.settings.clients -j [] -k inbounds.0.streamSettings.wsSettings.path -s ${V2RAY_WEBSOCKET_PATH}

readVariable "number of v2ray clients: " V2RAY_NUM
for ((i=1; i<=${V2RAY_NUM}; ++i))
do
  readVariable "user of v2ray client $i" V2RAY_CLIENT_USER
  readVariable "id of v2ray client $i" V2RAY_CLIENT_ID $(uuidgen)
  ${DIR}/config ${SETTINGS_PATH}/v2ray/client.json ${SETTINGS_PATH}/v2ray/test/client.json -k email -s ${V2RAY_CLIENT_USER} -k id -s ${V2RAY_CLIENT_ID}
  ${DIR}/config ${SETTINGS_PATH}/v2ray/test/server/config.json ${SETTINGS_PATH}/v2ray/test/server/config.json -k inbounds.0.settings.clients. -F ${SETTINGS_PATH}/v2ray/test/client.json
  readVariable "port of v2ray client $i" V2RAY_CLIENT_PORT 1080
  mkdir -p ${SETTINGS_PATH}/v2ray/test/clients/${V2RAY_CLIENT_USER}
  ${DIR}/config ${SETTINGS_PATH}/v2ray/client/config.json ${SETTINGS_PATH}/v2ray/test/clients/${V2RAY_CLIENT_USER}/config.json -k outbounds.1.settings.vnext.0.address -s ${V2RAY_SERVER_ADDR} -k outbounds.1.settings.vnext.0.users.0.id -s ${V2RAY_CLIENT_ID} -k outbounds.1.streamSettings.wsSettings.path -s ${V2RAY_WEBSOCKET_PATH} -k inbounds.0.port -i ${V2RAY_CLIENT_PORT}
done
logging info "Copy config.json to /etc/v2ray/config.json"

# sudo cp ${SETTINGS_PATH}/v2ray/test/server/config.json /etc/v2ray/config.json
# sudo systemctl restart v2ray.service
# logging info "Config v2ray done"
